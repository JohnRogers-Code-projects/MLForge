# Workflow: Copilot Review Handler
#
# Responds to Copilot code review submissions by:
# 1. Analyzing review comments for issues/suggestions
# 2. Setting commit status to block merge if issues found
# 3. Adding labels to track review state
#
# Note: Copilot always submits "comment" reviews (never approve/request_changes),
# so we must parse the content to determine if issues exist.

name: Copilot Review Handler

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  process-copilot-review:
    name: Process Copilot Review
    runs-on: ubuntu-latest

    # Only process reviews from Copilot
    if: github.event.review.user.login == 'copilot[bot]'

    steps:
      - name: Analyze review and set status
        uses: actions/github-script@v7
        with:
          script: |
            const review = context.payload.review;
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log(`Processing Copilot review for PR #${pr.number}`);
            console.log(`Review state: ${review.state}`);
            console.log(`Review body length: ${(review.body || '').length}`);

            // Fetch all review comments from this review
            const { data: comments } = await github.rest.pulls.listReviewComments({
              owner,
              repo,
              pull_number: pr.number,
            });

            // Filter to only Copilot's comments
            const copilotComments = comments.filter(c =>
              c.user.login === 'copilot[bot]'
            );

            console.log(`Found ${copilotComments.length} Copilot comments`);

            // Analyze for issues - look for common Copilot feedback patterns
            const issuePatterns = [
              /suggest/i,
              /should\s+be/i,
              /could\s+be/i,
              /consider/i,
              /issue/i,
              /bug/i,
              /error/i,
              /fix/i,
              /incorrect/i,
              /missing/i,
              /unused/i,
              /vulnerability/i,
              /security/i,
            ];

            let hasIssues = false;
            let issueCount = 0;
            const issueFiles = new Set();

            // Check review body
            const reviewBody = review.body || '';
            if (issuePatterns.some(p => p.test(reviewBody))) {
              hasIssues = true;
            }

            // Check each comment
            for (const comment of copilotComments) {
              const hasIssue = issuePatterns.some(p => p.test(comment.body));
              const hasSuggestion = comment.body.includes('```suggestion');

              if (hasIssue || hasSuggestion) {
                hasIssues = true;
                issueCount++;
                issueFiles.add(comment.path);
              }
            }

            console.log(`Analysis: hasIssues=${hasIssues}, issueCount=${issueCount}`);

            // Determine status
            const statusState = hasIssues ? 'failure' : 'success';
            const statusDesc = hasIssues
              ? `Copilot found ${issueCount} item(s) to address`
              : 'Copilot review passed';

            // Set commit status
            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha: pr.head.sha,
              state: statusState,
              context: 'copilot-review',
              description: statusDesc,
              target_url: review.html_url,
            });

            console.log(`Set commit status: ${statusState}`);

            // Define labels
            const labelsToAdd = [];
            const labelsToRemove = [];

            if (hasIssues) {
              labelsToAdd.push('copilot-needs-attention');
              labelsToRemove.push('copilot-approved');
            } else {
              labelsToAdd.push('copilot-approved');
              labelsToRemove.push('copilot-needs-attention');
            }

            // Ensure labels exist
            const labelConfigs = {
              'copilot-approved': { color: '0e8a16', description: 'Copilot found no issues' },
              'copilot-needs-attention': { color: 'd93f0b', description: 'Copilot found items to address' },
            };

            for (const [name, config] of Object.entries(labelConfigs)) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner,
                    repo,
                    name,
                    color: config.color,
                    description: config.description,
                  });
                  console.log(`Created label: ${name}`);
                }
              }
            }

            // Add labels
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.number,
                labels: labelsToAdd,
              });
              console.log(`Added labels: ${labelsToAdd.join(', ')}`);
            }

            // Remove old labels
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: pr.number,
                  name: label,
                });
                console.log(`Removed label: ${label}`);
              } catch (e) {
                // Label not on PR, ignore
              }
            }

            // Post summary if issues found
            if (hasIssues && issueFiles.size > 0) {
              const fileList = Array.from(issueFiles).map(f => `- \`${f}\``).join('\n');

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body: [
                  '## Copilot Review Summary',
                  '',
                  `Copilot found **${issueCount}** item(s) to review in the following files:`,
                  '',
                  fileList,
                  '',
                  '> Review the comments above and apply suggestions using the "Commit suggestion" button, or batch commit from the Files Changed tab.',
                  '',
                  '*This check will pass once all Copilot feedback is addressed.*',
                ].join('\n'),
              });
            }
