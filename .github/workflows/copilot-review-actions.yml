name: Copilot Review Actions

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  statuses: write

jobs:
  handle-copilot-review:
    # Only run for Copilot reviews (copilot[bot] or github-advanced-security[bot])
    if: |
      contains(fromJSON('["copilot[bot]", "github-advanced-security[bot]", "github-actions[bot]"]'), github.event.review.user.login)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get review details
        id: review
        run: |
          echo "state=${{ github.event.review.state }}" >> $GITHUB_OUTPUT
          echo "reviewer=${{ github.event.review.user.login }}" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.review.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Apply Copilot suggestions
        if: github.event.review.state == 'changes_requested' || github.event.review.state == 'commented'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get all review comments with suggestions
            const { data: comments } = await github.rest.pulls.listReviewComments({
              owner,
              repo,
              pull_number: prNumber,
            });

            // Filter for Copilot suggestions (comments with suggestion blocks)
            const copilotComments = comments.filter(c =>
              c.user.login.includes('copilot') ||
              c.user.login.includes('github-advanced-security')
            );

            const suggestionsApplied = [];

            for (const comment of copilotComments) {
              // Check if comment has a suggestion block
              const suggestionMatch = comment.body.match(/```suggestion\n([\s\S]*?)```/);
              if (suggestionMatch && comment.in_reply_to_id === undefined) {
                console.log(`Found suggestion in comment ${comment.id}`);
                suggestionsApplied.push({
                  file: comment.path,
                  line: comment.line || comment.original_line,
                  suggestion: suggestionMatch[1]
                });
              }
            }

            if (suggestionsApplied.length > 0) {
              // Post a comment about applied suggestions
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `ðŸ¤– **Copilot Review Actions**\n\nFound ${suggestionsApplied.length} suggestion(s) from Copilot.\n\n` +
                      `Files with suggestions:\n${suggestionsApplied.map(s => `- \`${s.file}\` (line ${s.line})`).join('\n')}\n\n` +
                      `> To apply these suggestions, use the "Commit suggestion" button on each review comment, or batch commit them from the Files Changed tab.`
              });
            }

            core.setOutput('suggestions_count', suggestionsApplied.length);

      - name: Add labels based on review state
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const reviewState = '${{ github.event.review.state }}';

            // Define label mappings
            const labelMap = {
              'approved': { add: ['copilot-approved'], remove: ['copilot-changes-requested', 'copilot-review-pending'] },
              'changes_requested': { add: ['copilot-changes-requested'], remove: ['copilot-approved', 'copilot-review-pending'] },
              'commented': { add: ['copilot-review-pending'], remove: [] }
            };

            const labels = labelMap[reviewState] || { add: [], remove: [] };

            // Ensure labels exist (create if needed)
            const labelColors = {
              'copilot-approved': '0e8a16',
              'copilot-changes-requested': 'd93f0b',
              'copilot-review-pending': 'fbca04'
            };

            for (const labelName of labels.add) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: labelName });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner, repo,
                    name: labelName,
                    color: labelColors[labelName] || 'ededed',
                    description: `Applied by Copilot review automation`
                  });
                }
              }
            }

            // Add new labels
            if (labels.add.length > 0) {
              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: prNumber,
                labels: labels.add
              });
              console.log(`Added labels: ${labels.add.join(', ')}`);
            }

            // Remove old labels
            for (const label of labels.remove) {
              try {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: prNumber,
                  name: label
                });
                console.log(`Removed label: ${label}`);
              } catch (e) {
                // Label might not exist on PR, ignore
              }
            }

      - name: Set commit status for merge blocking
        uses: actions/github-script@v7
        with:
          script: |
            const reviewState = '${{ github.event.review.state }}';
            const sha = context.payload.pull_request.head.sha;

            // Map review state to commit status
            const statusMap = {
              'approved': { state: 'success', description: 'Copilot approved this PR' },
              'changes_requested': { state: 'failure', description: 'Copilot requested changes' },
              'commented': { state: 'pending', description: 'Copilot review in progress' },
              'dismissed': { state: 'pending', description: 'Copilot review dismissed' }
            };

            const status = statusMap[reviewState] || { state: 'pending', description: 'Awaiting Copilot review' };

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: status.state,
              context: 'copilot-review',
              description: status.description,
              target_url: context.payload.review.html_url
            });

            console.log(`Set commit status to ${status.state}: ${status.description}`);

  # Separate job to create initial pending status when PR is opened
  set-pending-status:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Set pending status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'pending',
              context: 'copilot-review',
              description: 'Awaiting Copilot code review'
            });
